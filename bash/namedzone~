#!/bin/bash
#
# tnm@eurotux.com <Thiago Melo>
#

BLUE='\[\033[38;5;39m\]'
PALE_YELLOW='\[\033[38;5;229m\]'
GREEN='\[\033[38;5;76m\]'
YELLOW='\[\033[38;5;226m\]'
RED='\[\033[38;5;196m\]'
CYAN='\[\033[38;5;14m\]'
RESET='\[$(tput sgr0)\]'

if [ $# -eq 0 ] ; then
        echo "Usage: namedzone domain zonefile certificate" 
        exit 0
fi

zonefile=$2
domainsufix=$1
certificate=$3

certdate=`openssl x509 -in Certificados/wildcard.eurotux.com-2021.crt -text -noout | grep "Not After" | awk -F" : " '{print $2}'`
echo $certdate

while read zone
   do   prefix=`echo $zone | awk '{print $1}'`
   	flag=`echo $zone | awk '{print $3}'`
	ip=`echo $zone | awk '{print $4}'`
	if [[ $flag == "A" ]]
         	then
		#echo $prefix $flag $ip
#		expired=$(echo |openssl s_client -servername $prefix.$domainsufix -connect $prefix.$domainsufix:443 | openssl x509 -noout -dates | grep notAfter | awk -F"=" '{print $2}')
		#expired=$(curl --insecure -v https://$prefix.$domainsufix 2>&1 | awk 'BEGIN { cert=0 } /^\* Server certificate:/ { cert=1 } /^\*/ { if (cert) print }' | grep expire)
		expired=`curl --connect-timeout 5 --insecure -v https://$prefix.$domainsufix 2>&1 | awk 'BEGIN { cert=0 } /^\* Server certificate:/ { cert=1 } /^\*/ { if (cert) print }' | grep expire`
		echo "$prefix.$domainsufix $expired"
	fi
done < $zonefile
